#!/bin/bash

IN_FILE=$1
OUT_FILE_PREFIX=$2
OUT_FOLDER=$(dirname "$OUT_FILE")
OUT_AUDIO=${OUT_FILE_PREFIX}.mp3
OUT_IMAGE=${OUT_FILE_PREFIX}.png
OUT_VIDEO=${OUT_FILE_PREFIX}.mp4

timidity "$IN_FILE" -Ow -o - | ffmpeg -y -loglevel warning -i - -acodec libmp3lame -ab 64k "$OUT_AUDIO"
convert -pointsize 960 -font Noto-Mono label:"$(date +%Y/%m/%d)" "$OUT_IMAGE"
ffmpeg -y -loglevel warning -loop 1 -i "$OUT_IMAGE" -i "$OUT_AUDIO" -c:a copy -c:v libx264 -shortest "$OUT_VIDEO"
